---
title: "04_Granger_test"
author: "Hongbo_Zhao"
format: html
editor: visual
---

## 1. Granger Causality Test for Predictor Selection

This section identifies statistically significant predictors of monthly copper cable theft using the Granger causality test. The goal is to assess whether past values of potential explanatory variables contain predictive information about future traffic copper cable theft occurrences, thereby guiding model specification. We examine six candidate predictors: `intervention`, `Total_theft`, `Copper_price`, `Unwork_NSW`, `Scrap_Imports_CN`, and `t_since`.\
\
Each variable is tested over 1–6 month lags to capture short- and medium-term effects. The dataset is divided into training (2010–2021) and testing (2021–2023) subsets to ensure temporal consistency.

The custom function `get_granger_p()` automates p-value extraction from `grangertest()` results, iterating through all variable-lag pairs. Results are visualized via a color-coded heatmap, where each cell represents the statistical significance of a variable–lag combination (`p < 0.01`, `p < 0.05`, `p < 0.1`, or not significant).

```{r}
options(repos = c(CRAN = "https://cloud.r-project.org"))

# Split into training and tesing datasets
train_data <- combined_data %>% filter(date >= as.Date("2010-01-01") & date < as.Date("2021-07-01"))
test_data <- combined_data %>% filter(date >= as.Date("2021-07-01") & date < as.Date("2023-06-01"))

# Define candidate variables and lags
variables_Granger <- c("intervention", "Total_theft", "Copper_price", "Unwork_NSW", "Scrap_Imports_CN", "t_since")
lags <- 1:6

# Function to compute p-value from Granger test
get_granger_p <- function(var, lag) {
  formula <- reformulate(var, response = "cases")
  test <- grangertest(formula, order = lag, data = train_data)
  return(test$`Pr(>F)`[2])
}

# Generate p-values for all combinations
granger_results_all <- expand.grid(Variable = variables_Granger, Lag = lags) %>%
  mutate(P_Value = map2_dbl(as.character(Variable), Lag, get_granger_p))

# Reshape to wide format
granger_wide <- granger_results_all %>%
  mutate(Lag = paste0("Lag_", Lag, "_month")) %>%
  pivot_wider(names_from = Lag, values_from = P_Value)

# Label mapping for plot
variable_labels <- c(
  intervention = "Legislation (Binary)",
  Total_theft = "Overall theft (NSW)",
  Copper_price = "Global copper price",
  Unwork_NSW = "Unemployment rate (NSW)",
  Scrap_Imports_CN = "Scrap copper Imports (CN)",
  t_since = "Legislation (cummulative)"
)

# Prepare visualization data
granger_plot_data <- granger_results_all %>%
  mutate(
    Variable_Label = variable_labels[Variable],
    Lag_Label = paste0("Lag ", Lag),
    Significance = cut(
      P_Value,
      breaks = c(-Inf, 0.01, 0.05, 0.1, Inf),
      labels = c("p < 0.01", "p < 0.05", "p < 0.1", "Not significant")
    )
  )

# Plot heatmap
ggplot(granger_plot_data, aes(x = Lag_Label, y = Variable_Label, fill = Significance)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2e", P_Value)), size = 3.5) +
  scale_fill_manual(values = c("p < 0.01" = "#b2182b", "p < 0.05" = "#ef8a62", "p < 0.1" = "#fee08b", "Not significant" = "#66c2a5")) +
  theme_minimal(base_size = 10) +
  labs(
    title = "Granger Causality Test Results (p-values)",
    x = "Lag", y = "Variable",
    fill = "Significance Level"
  ) +
  theme(
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    panel.grid = element_blank()
  )
```

```{r}
####Setting the format of the graph####

library(dplyr)
library(ggplot2)
library(grid)
library(scales)

windowsFonts(
  Times = windowsFont("Times New Roman")
)


piecewise_rescale <- function(p){
  ifelse(p < 0.01, rescale(p,  to = c(0.00, 0.20), from = c(0.00, 0.01)),
  ifelse(p < 0.04, rescale(p,  to = c(0.20, 0.40), from = c(0.01, 0.04)),
  ifelse(p < 0.06, rescale(p,  to = c(0.40, 0.60), from = c(0.04, 0.06)),
  ifelse(p < 0.10, rescale(p,  to = c(0.60, 0.80), from = c(0.06, 0.10)),
                 rescale(p,  to = c(0.80, 1.00), from = c(0.10, 1.00))))))
}


granger_plot_data <- granger_plot_data %>%
  mutate(
    label_txt = sprintf("%.3f", P_Value),
    label_col = ifelse(P_Value < 0.02 | P_Value > 0.70, "black", "black"),
    P_scaled  = piecewise_rescale(P_Value)
  )


cols <- c("#D83228", "#F08976", "#F0F1F4", "#C6CFE3", "#557EB9", "royalblue4")
vals <- c(0.00, 0.20, 0.40, 0.60, 0.80, 1.00)


ggplot(granger_plot_data, aes(x = Lag_Label, y = Variable_Label, fill = P_scaled)) +
  geom_tile(color = NA) +
  geom_text(aes(label = label_txt, colour = label_col),
            size = 3.2, family = "Times") +
  scale_colour_identity() +
  scale_fill_gradientn(
    colors = cols,
    values = vals,
    limits = c(0, 1),
    oob = scales::squish,
    name = "p-value",
    breaks = c(0.10, 0.30, 0.50, 0.70, 0.90),
    labels = c("p < 0.01", "0.01", "0.04", "0.06", "Not significant"),
    guide = guide_colorbar(
      barheight   = unit(6, "cm"),
      barwidth    = unit(0.55, "cm"),
      ticks.colour = "black",
      frame.colour = "black"
    )
  ) +
  labs(title = "Granger Causality Test Results (p-values)",
       x = "Lag", y = "Variable") +
  coord_fixed() +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  theme_minimal(base_size = 12) +
  theme(
    text = element_text(family = "Times"),
    plot.title = element_text(size = 16, face = "bold", margin = margin(0,0,8,0)),
    axis.title  = element_text(size = 12),
    axis.text   = element_text(size = 12, colour = "grey20"),
    panel.grid  = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 12),
    legend.text  = element_text(size = 12),
    plot.background = element_rect(fill = "white", colour = NA)
  )
```

## 2. Lag and Seasonal Feature Construction for Predictive Modelling

This section constructs lagged and seasonal features for downstream predictive models.\
\
Using results from the Granger test, we generate lagged versions of explanatory variables at their optimal lag orders—such as a 1-month lag for `Copper_price` and a 6-month lag for `Scrap_Imports_CN`—to maintain temporal causality alignment with the response variable `cases`.

To address skewness and zero-value issues, both dependent and explanatory variables are transformed using `log(x + 1)`, improving interpretability within the log–log framework.\
\
Additionally, monthly seasonal dummies (February–December) are created from the `Month` variable to control for intra-annual seasonality in theft occurrences, using January as the reference group.

```{r}
library(dplyr)
library(lubridate)


# Extract month information

combined_data <- combined_data %>%
  mutate(Month = as.factor(month(date)))


# Generate lagged variables

combined_data <- combined_data %>%
  mutate(
    cases_1.lag         = lag(cases, 1),
    cases_2.lag         = lag(cases, 2),
    intervention.lag    = lag(intervention, 1),
    Total_theft.lag     = lag(Total_theft, 1),
    Copper_price.lag    = lag(Copper_price, 1),
    t_since.lag         = lag(t_since, 1),
    Unwork_NSW.lag      = lag(Unwork_NSW, 4),
    Scrap_Imports_CN.lag= lag(Scrap_Imports_CN, 5),
    cases_lag1_diff     = cases_1.lag - cases_2.lag
  )


# Remove missing values generated after lagging

combined_data <- combined_data %>%
  filter(
    !is.na(cases_1.lag),
    !is.na(cases_2.lag),
    !is.na(intervention.lag),
    !is.na(Total_theft.lag),
    !is.na(Copper_price.lag),
    !is.na(t_since.lag),
    !is.na(Unwork_NSW.lag),
    !is.na(Scrap_Imports_CN.lag)
  )


# Create logarithmic variables and their differences

combined_data <- combined_data %>%
  mutate(
    log_cases                 = log(cases + 1), 
    log_cases_1.lag           = log(cases_1.lag + 1),
    log_cases_2.lag           = log(cases_2.lag + 1),
    log_Total_theft.lag       = log(Total_theft.lag + 1),
    log_Copper_price.lag      = log(Copper_price.lag + 1),
    log_t_since.lag           = log(t_since.lag + 1),
    log_Unwork_NSW.lag        = log(Unwork_NSW.lag + 1),
    log_Scrap_Imports_CN.lag  = log(Scrap_Imports_CN.lag + 1),
    log_cases_diff            = log_cases_1.lag - log_cases_2.lag
  )


# Split into training and testing datasets

train_data <- combined_data %>% 
  filter(date >= as.Date("2010-01-01") & date < as.Date("2021-07-01"))
test_data <- combined_data %>% 
  filter(date >= as.Date("2021-07-01") & date < as.Date("2023-06-01"))


# Generate monthly dummy variables

train_data <- train_data %>%
  mutate(
    Feb = ifelse(Month == 2, 1, 0),
    Mar = ifelse(Month == 3, 1, 0),
    APr = ifelse(Month == 4, 1, 0),
    May = ifelse(Month == 5, 1, 0),
    Jun = ifelse(Month == 6, 1, 0),
    Jul = ifelse(Month == 7, 1, 0),
    Aug = ifelse(Month == 8, 1, 0),
    Sep = ifelse(Month == 9, 1, 0),
    Oct = ifelse(Month == 10, 1, 0),
    Nov = ifelse(Month == 11, 1, 0),
    Dec = ifelse(Month == 12, 1, 0),
  )



test_data <- test_data %>%
  mutate(
    Feb = ifelse(Month == 2, 1, 0),
    Mar = ifelse(Month == 3, 1, 0),
    APr = ifelse(Month == 4, 1, 0),
    May = ifelse(Month == 5, 1, 0),
    Jun = ifelse(Month == 6, 1, 0),
    Jul = ifelse(Month == 7, 1, 0),
    Aug = ifelse(Month == 8, 1, 0),
    Sep = ifelse(Month == 9, 1, 0),
    Oct = ifelse(Month == 10, 1, 0),
    Nov = ifelse(Month == 11, 1, 0),
    Dec = ifelse(Month == 12, 1, 0)
  )
```

Last updated: 23 July 2025 Maintainer: \[Hongbo Zhao / Contact: hongbo.zhao\@uqconnect.edu.au\]\
\
